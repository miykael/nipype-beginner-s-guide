<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Nipype Beginner&#39;s Guide &mdash; All you need to know to become an expert in Nipype</title>
    
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="search" title="Search" href="search.html" />
    <link rel="top" title="All you need to know to become an expert in Nipype" href="index.html" />
    <link rel="next" title="How To Build A Pipeline For A Second Level fMRI Analysis" href="secondLevel.html" />
    <link rel="prev" title="How To Build A Pipeline For A First Level fMRI Analysis" href="firstLevel.html" />
    <meta name="keywords" content="nipype, neuroimaging, pipeline, workflow, parallel, python, neuroscience, python, guide, mri, fmri, dti, tutorial, user guide">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-24958678-1', 'auto');
      ga('send', 'pageview');

    </script>

  </head>
  <body>

    <div class="headertext" >
     <a href="index.html">
        Nipype Beginner's Guide</a>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="secondLevel.html" title="How To Build A Pipeline For A Second Level fMRI Analysis"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="firstLevel.html" title="How To Build A Pipeline For A First Level fMRI Analysis"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Home</a>|</li>
        <li><a href="http://miykael.github.com/nipype-beginner-s-guide/tableofcontent.html">Table of Contents</a>|</li>
        <li><a href="http://miykael.github.com/nipype-beginner-s-guide/faq.html">FAQ</a>|</li>
        <li><a href="http://miykael.github.com/nipype-beginner-s-guide/glossary.html">Glossary</a>|</li>
        <li><a href="https://github.com/miykael/nipype-beginner-s-guide/">github</a>|</li>
        <li><a href="http://nipy.org/nipype/">Nipype</a>|</li>
        <li><a href="http://miykael.github.io/nipype-beginner-s-guide/help.html">Help</a>|</li> 
      </ul>
    </div>
  
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/nipype-beginners-guide-html_logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">How To Normalize Your Data</a><ul>
<li><a class="reference internal" href="#normalize-your-data-with-ants">Normalize Your Data with ANTs</a><ul>
<li><a class="reference internal" href="#import-modules-and-specify-interface-behaviors">Import modules and specify interface behaviors</a></li>
<li><a class="reference internal" href="#define-experiment-specific-parameters">Define experiment specific parameters</a></li>
<li><a class="reference internal" href="#create-nodes">Create nodes</a><ul>
<li><a class="reference internal" href="#partial-transformation">Partial Transformation</a></li>
<li><a class="reference internal" href="#complete-transformation">Complete Transformation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#create-the-pipeline-and-connect-nodes-to-it">Create the pipeline and connect nodes to it</a></li>
<li><a class="reference internal" href="#establish-input-output-stream">Establish Input &amp; Output Stream</a></li>
<li><a class="reference internal" href="#run-the-pipeline-and-generate-the-graphs">Run the pipeline and generate the graphs</a></li>
<li><a class="reference internal" href="#visualize-the-workflow">Visualize the workflow</a></li>
<li><a class="reference internal" href="#resulting-folder-structure">Resulting Folder Structure</a></li>
</ul>
</li>
<li><a class="reference internal" href="#normalize-your-data-with-spm12">Normalize Your Data with SPM12</a><ul>
<li><a class="reference internal" href="#id1">Import modules and specify interface behaviors</a></li>
<li><a class="reference internal" href="#id2">Define experiment specific parameters</a></li>
<li><a class="reference internal" href="#id3">Create nodes</a></li>
<li><a class="reference internal" href="#id4">Create the pipeline and connect nodes to it</a></li>
<li><a class="reference internal" href="#id5">Establish Input &amp; Output Stream</a></li>
<li><a class="reference internal" href="#id6">Run the pipeline and generate the graphs</a></li>
<li><a class="reference internal" href="#id7">Visualize the workflow</a></li>
<li><a class="reference internal" href="#id8">Resulting Folder Structure</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="firstLevel.html"
                        title="previous chapter">How To Build A Pipeline For A First Level fMRI Analysis</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="secondLevel.html"
                        title="next chapter">How To Build A Pipeline For A Second Level fMRI Analysis</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/normalize.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">

            
  <div class="admonition important">
<p class="admonition-title">Important</p>
<p>This guide hasn’t been updated since January 2017 and is based on an older version of Nipype. The code in this guide is not tested against newer Nipype versions and might not work anymore. For a newer, more up to date and better introduction to Nipype, please check out the the <a class="reference external" href="https://miykael.github.io/nipype_tutorial/">Nipype Tutorial</a>.</p>
</div>
<div class="section" id="how-to-normalize-your-data">
<h1>How To Normalize Your Data<a class="headerlink" href="#how-to-normalize-your-data" title="Permalink to this headline">¶</a></h1>
<p>Before you can start with a second level analysis you are facing the problem that all your output from the first level analysis are still in their subject specific subject-space. Because of the huge differences in brain size and cortical structure, it is very important to transform the data of each subject from its individual subject-space into a common standardized reference-space. This process of transformation is what we call normalization and it consists of a rigid body transformation (translations and rotations) as well as of a affine transformation (zooms and shears). The most common template that subject data is normalized to is the <a class="reference external" href="http://www.bic.mni.mcgill.ca/ServicesAtlases/HomePage">MNI template</a>.</p>
<p>There are many different approaches to when to normalize your data (e.g. before smoothing your data in preprocessing or after the estimation of your contrasts at the end of your first level analysis). I prefer to do the normalization after the first level model was estimated, as I don’t want to introduce to many unnecessary transformations in the subject specific first level analysis.</p>
<p>There are also many different softwares that you could use to normalize your data and there is a lot of debate of which ones are better and which ones are worse. There is a very good paper by Klein et al. (2009), called <a class="reference external" href="http://www.ncbi.nlm.nih.gov/pmc/articles/PMC2747506/">Evaluation of 14 nonlinear deformation algorithms applied to human brain MRI registration</a>, that summarizes and compares the main approaches. According to this paper and from my own personal experience, I highly recommend to use <a class="reference external" href="http://stnava.github.io/ANTs/">ANTs</a> to normalize your data. I also recommend to not use SPM8’s normalization module (to see why check out <a class="reference external" href="http://www.fil.ion.ucl.ac.uk/spm/software/spm12/SPM12_Release_Notes.pdf#page=9">SPM12’s release notes</a>, page 9, section “8.5. Old Normalise”). In contrary to SPM8, SPM12’s new normalization approach seems to do very good.</p>
<p>This section will show you how to use Nipype to do a normalization with ANTs (what I recommend) or with SPM12. I highly recommend the normalization with ANTs as it is much more accurate. But I also want to point out that the computation of ANTs normalization is much longer than the one with SPM12, which also does a good enough job.</p>
<div class="section" id="normalize-your-data-with-ants">
<h2>Normalize Your Data with ANTs<a class="headerlink" href="#normalize-your-data-with-ants" title="Permalink to this headline">¶</a></h2>
<p>Usually, we first normalize the subject specific anatomy to the template and then use the resulting transformation matrix to normalize the functional data (i.e. first level contrasts) to the template. But this also means that we assume that the functional and the anatomical data is laying on top of each other, or in other words, that they were coregistered to each other.</p>
<p>The coregistration of the functional data to the anatomical data means multiple interpolation of your data. That’s why the coregistration and the normalization of your functional data should be done directly in one transformation. To account for both possible cases, the following script will show you both ways. The approach where both coregistration and normalization will be done in one step will be called <strong>complete transformation</strong>, and the approach where we only do a normalization will be called <strong>partial transformation</strong>. Partial does not mean that it doesn’t lead to a complete normalization of the data, it just means that the coregistration of the functional and structural data was already done in an earlier step.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>A big thanks to <a class="reference external" href="https://github.com/juhuntenburg">Julia Huntenburg</a>! Without her help and knowledge about ANTs and Nipype this section wouldn’t exist, as she provided me with the relevant code and structure of this pipeline.</p>
</div>
<div class="section" id="import-modules-and-specify-interface-behaviors">
<h3>Import modules and specify interface behaviors<a class="headerlink" href="#import-modules-and-specify-interface-behaviors" title="Permalink to this headline">¶</a></h3>
<p>But first, as always, we have to import necessary modules and tell the system where to find the FreeSurfer folder.</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Import modules</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">opj</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.ants</span> <span class="kn">import</span> <span class="n">Registration</span><span class="p">,</span> <span class="n">ApplyTransforms</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.freesurfer</span> <span class="kn">import</span> <span class="n">FSCommand</span><span class="p">,</span> <span class="n">MRIConvert</span><span class="p">,</span> <span class="n">BBRegister</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.c3</span> <span class="kn">import</span> <span class="n">C3dAffineTool</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.utility</span> <span class="kn">import</span> <span class="n">IdentityInterface</span><span class="p">,</span> <span class="n">Merge</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.io</span> <span class="kn">import</span> <span class="n">SelectFiles</span><span class="p">,</span> <span class="n">DataSink</span><span class="p">,</span> <span class="n">FreeSurferSource</span>
<span class="kn">from</span> <span class="nn">nipype.pipeline.engine</span> <span class="kn">import</span> <span class="n">Workflow</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">MapNode</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.fsl</span> <span class="kn">import</span> <span class="n">Info</span>

<span class="c1"># FreeSurfer - Specify the location of the freesurfer folder</span>
<span class="n">fs_dir</span> <span class="o">=</span> <span class="s1">&#39;~/nipype_tutorial/freesurfer&#39;</span>
<span class="n">FSCommand</span><span class="o">.</span><span class="n">set_default_subjects_dir</span><span class="p">(</span><span class="n">fs_dir</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="define-experiment-specific-parameters">
<h3>Define experiment specific parameters<a class="headerlink" href="#define-experiment-specific-parameters" title="Permalink to this headline">¶</a></h3>
<p>Now we define the names of the folders used for this pipeline, we specify the list of subjects which should be normalized and specify which template the data should be normalized too. In this case it is the <code class="docutils literal notranslate"><span class="pre">MNI152_T1_1mm_brain.nii.gz</span></code> template.</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Specify variables</span>
<span class="n">experiment_dir</span> <span class="o">=</span> <span class="s1">&#39;~/nipype_tutorial&#39;</span>          <span class="c1"># location of experiment folder</span>
<span class="n">input_dir_1st</span> <span class="o">=</span> <span class="s1">&#39;output_fMRI_example_1st&#39;</span>     <span class="c1"># name of 1st-level output folder</span>
<span class="n">output_dir</span> <span class="o">=</span> <span class="s1">&#39;output_fMRI_example_norm_ants&#39;</span>  <span class="c1"># name of norm output folder</span>
<span class="n">working_dir</span> <span class="o">=</span> <span class="s1">&#39;workingdir_fMRI_example_norm_ants&#39;</span>  <span class="c1"># name of norm working directory</span>
<span class="n">subject_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sub001&#39;</span><span class="p">,</span> <span class="s1">&#39;sub002&#39;</span><span class="p">,</span> <span class="s1">&#39;sub003&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sub004&#39;</span><span class="p">,</span> <span class="s1">&#39;sub005&#39;</span><span class="p">,</span> <span class="s1">&#39;sub006&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sub007&#39;</span><span class="p">,</span> <span class="s1">&#39;sub008&#39;</span><span class="p">,</span> <span class="s1">&#39;sub009&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sub010&#39;</span><span class="p">]</span>                     <span class="c1"># list of subject identifiers</span>

<span class="c1"># location of template file</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">Info</span><span class="o">.</span><span class="n">standard_image</span><span class="p">(</span><span class="s1">&#39;MNI152_T1_1mm_brain.nii.gz&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>For other templates check out the ones in FSL’s <code class="docutils literal notranslate"><span class="pre">standard</span></code> folder, in my case this is under <code class="docutils literal notranslate"><span class="pre">/usr/share/fsl/data/standard</span></code>. You can also see a list and access them much easier within Nipype with the following code:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nipype.interfaces.fsl</span> <span class="kn">import</span> <span class="n">Info</span>
<span class="n">Info</span><span class="o">.</span><span class="n">standard_image</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="create-nodes">
<h3>Create nodes<a class="headerlink" href="#create-nodes" title="Permalink to this headline">¶</a></h3>
<p>In both cases, the <strong>complete</strong> as well as the <strong>partial</strong> transformation approach, we will use ANTs’ <code class="docutils literal notranslate"><span class="pre">Registration</span></code> to compute the transformation matrix between the subject specific anatomy and the template:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Registration (good) - computes registration between subject&#39;s structural and MNI template.</span>
<span class="n">antsreg</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">Registration</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s1">&#39;--float&#39;</span><span class="p">,</span>
                            <span class="n">collapse_output_transforms</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">fixed_image</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
                            <span class="n">initial_moving_transform_com</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">num_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">output_inverse_warped_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">output_warped_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">sigma_units</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;vox&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
                            <span class="n">transforms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Rigid&#39;</span><span class="p">,</span> <span class="s1">&#39;Affine&#39;</span><span class="p">,</span> <span class="s1">&#39;SyN&#39;</span><span class="p">],</span>
                            <span class="n">terminal_output</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span>
                            <span class="n">winsorize_lower_quantile</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>
                            <span class="n">winsorize_upper_quantile</span><span class="o">=</span><span class="mf">0.995</span><span class="p">,</span>
                            <span class="n">convergence_threshold</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-06</span><span class="p">],</span>
                            <span class="n">convergence_window_size</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>
                            <span class="n">metric</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MI&#39;</span><span class="p">,</span> <span class="s1">&#39;MI&#39;</span><span class="p">,</span> <span class="s1">&#39;CC&#39;</span><span class="p">],</span>
                            <span class="n">metric_weight</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
                            <span class="n">number_of_iterations</span><span class="o">=</span><span class="p">[[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
                                                  <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
                                                  <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">20</span><span class="p">]],</span>
                            <span class="n">radius_or_number_of_bins</span><span class="o">=</span><span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                            <span class="n">sampling_percentage</span><span class="o">=</span><span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                            <span class="n">sampling_strategy</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Regular&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;Regular&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;None&#39;</span><span class="p">],</span>
                            <span class="n">shrink_factors</span><span class="o">=</span><span class="p">[[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
                            <span class="n">smoothing_sigmas</span><span class="o">=</span><span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
                            <span class="n">transform_parameters</span><span class="o">=</span><span class="p">[(</span><span class="mf">0.1</span><span class="p">,),</span>
                                                  <span class="p">(</span><span class="mf">0.1</span><span class="p">,),</span>
                                                  <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)],</span>
                            <span class="n">use_histogram_matching</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">write_composite_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;antsreg&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>This registration node <code class="docutils literal notranslate"><span class="pre">antsreg</span></code> might take a while, depending on the power of your system. One way to speed up this process is by using multiple cores/threads for the calculation. For example, use 4 cores for the calculation by setting the parameter <code class="docutils literal notranslate"><span class="pre">num_threads</span></code> to 4. But be aware, that if you run the normalization pipeline for 10 subjects in parallel, the code will try to launch 10 instances of ANTs registration with each asking for 4 cores.</p>
<p>Another approach to reduce the computation time of the registration is by reducing its accuracy by changing the parameters of <code class="docutils literal notranslate"><span class="pre">Registration</span></code> according to the following script: <a class="reference external" href="https://github.com/stnava/ANTs/blob/master/Scripts/newAntsExample.sh">https://github.com/stnava/ANTs/blob/master/Scripts/newAntsExample.sh</a> to the following:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Registration (fast) - computes registration between subject&#39;s structural and MNI template.</span>
<span class="n">antsregfast</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">Registration</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s1">&#39;--float&#39;</span><span class="p">,</span>
                                <span class="n">collapse_output_transforms</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">fixed_image</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
                                <span class="n">initial_moving_transform_com</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">num_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">output_inverse_warped_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">output_warped_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">sigma_units</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;vox&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">transforms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Rigid&#39;</span><span class="p">,</span> <span class="s1">&#39;Affine&#39;</span><span class="p">,</span> <span class="s1">&#39;SyN&#39;</span><span class="p">],</span>
                                <span class="n">terminal_output</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span>
                                <span class="n">winsorize_lower_quantile</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>
                                <span class="n">winsorize_upper_quantile</span><span class="o">=</span><span class="mf">0.995</span><span class="p">,</span>
                                <span class="n">convergence_threshold</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-08</span><span class="p">,</span> <span class="mf">1e-08</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">],</span>
                                <span class="n">convergence_window_size</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
                                <span class="n">metric</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Mattes&#39;</span><span class="p">,</span> <span class="s1">&#39;Mattes&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Mattes&#39;</span><span class="p">,</span> <span class="s1">&#39;CC&#39;</span><span class="p">]],</span>
                                <span class="n">metric_weight</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]],</span>
                                <span class="n">number_of_iterations</span><span class="o">=</span><span class="p">[[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">11110</span><span class="p">,</span> <span class="mi">11110</span><span class="p">],</span>
                                                      <span class="p">[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">11110</span><span class="p">,</span> <span class="mi">11110</span><span class="p">],</span>
                                                      <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">20</span><span class="p">]],</span>
                                <span class="n">radius_or_number_of_bins</span><span class="o">=</span><span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">]],</span>
                                <span class="n">sampling_percentage</span><span class="o">=</span><span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]],</span>
                                <span class="n">sampling_strategy</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Regular&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;Regular&#39;</span><span class="p">,</span>
                                                   <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]],</span>
                                <span class="n">shrink_factors</span><span class="o">=</span><span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                                <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                                <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
                                <span class="n">smoothing_sigmas</span><span class="o">=</span><span class="p">[[</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                                                  <span class="p">[</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                                                  <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]],</span>
                                <span class="n">transform_parameters</span><span class="o">=</span><span class="p">[(</span><span class="mf">0.1</span><span class="p">,),</span>
                                                      <span class="p">(</span><span class="mf">0.1</span><span class="p">,),</span>
                                                      <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)],</span>
                                <span class="n">use_estimate_learning_rate_once</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">use_histogram_matching</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                                <span class="n">write_composite_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                   <span class="n">name</span><span class="o">=</span><span class="s1">&#39;antsregfast&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Now that we have the transformation matrix to normalize the functional data to the template, we  can use ANTs’ <code class="docutils literal notranslate"><span class="pre">ApplyTransforms</span></code> to execute that. <strong>Note</strong>: Here you have again the option to specify the number of threads used in the interpolation of the data.</p>
<div class="section" id="partial-transformation">
<h4>Partial Transformation<a class="headerlink" href="#partial-transformation" title="Permalink to this headline">¶</a></h4>
<p>In the partial transformation approach, we only need the following additional nodes. One to normalize the anatomical and one to normalize the functional data.</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Apply Transformation - applies the normalization matrix to contrast images</span>
<span class="n">apply2con</span> <span class="o">=</span> <span class="n">MapNode</span><span class="p">(</span><span class="n">ApplyTransforms</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s1">&#39;--float&#39;</span><span class="p">,</span>
                                    <span class="n">input_image_type</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                    <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;Linear&#39;</span><span class="p">,</span>
                                    <span class="n">invert_transform_flags</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">],</span>
                                    <span class="n">num_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">reference_image</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
                                    <span class="n">terminal_output</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;apply2con&#39;</span><span class="p">,</span> <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;input_image&#39;</span><span class="p">])</span>

<span class="c1"># Apply Transformation - applies the normalization matrix to the mean image</span>
<span class="n">apply2mean</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">ApplyTransforms</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s1">&#39;--float&#39;</span><span class="p">,</span>
                                  <span class="n">input_image_type</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                  <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;Linear&#39;</span><span class="p">,</span>
                                  <span class="n">invert_transform_flags</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">],</span>
                                  <span class="n">num_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">reference_image</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
                                  <span class="n">terminal_output</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">),</span>
                  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;apply2mean&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="complete-transformation">
<h4>Complete Transformation<a class="headerlink" href="#complete-transformation" title="Permalink to this headline">¶</a></h4>
<p>For the complete transformation, we also need to calculate the coregistration matrix (we will use FreeSurfer’s <cite>BBRegister</cite> for that). But first, we need to use FreeSurfer’s <code class="docutils literal notranslate"><span class="pre">FreeSurferSource</span></code> to grab the subject specific anatomy, convert it from MGZ to NII format with <code class="docutils literal notranslate"><span class="pre">MRIConvert</span></code>. Than we need to transform the BBRegister transformation matrix to ITK format with <code class="docutils literal notranslate"><span class="pre">C3dAffineTool</span></code> and merge this transformation matrix with the transformation matrix from the normalization, i.e. <code class="docutils literal notranslate"><span class="pre">antsreg</span></code>, by using a <code class="docutils literal notranslate"><span class="pre">Merge</span></code> node.</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># FreeSurferSource - Data grabber specific for FreeSurfer data</span>
<span class="n">fssource</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">FreeSurferSource</span><span class="p">(</span><span class="n">subjects_dir</span><span class="o">=</span><span class="n">fs_dir</span><span class="p">),</span>
                <span class="n">run_without_submitting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fssource&#39;</span><span class="p">)</span>

<span class="c1"># Convert FreeSurfer&#39;s MGZ format into NIfTI format</span>
<span class="n">convert2nii</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">MRIConvert</span><span class="p">(</span><span class="n">out_type</span><span class="o">=</span><span class="s1">&#39;nii&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;convert2nii&#39;</span><span class="p">)</span>

<span class="c1"># Coregister the median to the surface</span>
<span class="n">bbregister</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">BBRegister</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="s1">&#39;fsl&#39;</span><span class="p">,</span>
                             <span class="n">contrast_type</span><span class="o">=</span><span class="s1">&#39;t2&#39;</span><span class="p">,</span>
                             <span class="n">out_fsl_file</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bbregister&#39;</span><span class="p">)</span>

<span class="c1"># Convert the BBRegister transformation to ANTS ITK format</span>
<span class="n">convert2itk</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">C3dAffineTool</span><span class="p">(</span><span class="n">fsl2ras</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">itk_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                   <span class="n">name</span><span class="o">=</span><span class="s1">&#39;convert2itk&#39;</span><span class="p">)</span>


<span class="c1"># Concatenate BBRegister&#39;s and ANTS&#39; transforms into a list</span>
<span class="n">merge</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">Merge</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in2&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mergexfm&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Before you can use the <code class="docutils literal notranslate"><span class="pre">C3dAffineTool</span></code> you have to make sure that you have the C3D routines on your system. Otherwise you get the following error: <code class="docutils literal notranslate"><span class="pre">IOError:</span> <span class="pre">c3d_affine_tool</span> <span class="pre">could</span> <span class="pre">not</span> <span class="pre">be</span> <span class="pre">found</span> <span class="pre">on</span> <span class="pre">host</span></code>. To download the newest C3D version, go to <a class="reference external" href="http://sourceforge.net/projects/c3d/">this homepage</a>. Afterwards, unpack and install the code on your system, this can be done with the following command: <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">tar</span> <span class="pre">xzvf</span> <span class="pre">~/Downloads/c3d-nightly-Linux-x86_64.tar.gz</span> <span class="pre">-C</span> <span class="pre">/usr/local/.</span></code>. And finally, to make sure that your system finds the binaries of this software, add the following line to your <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code> file: <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">PATH=/usr/local/c3d-1.0.0-Linux-x86_64/bin:$PATH</span></code>.</p>
</div>
<p>Now that we have the couplet transformation matrix, we can normalize the anatomical and functional data with the following two nodes:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Transform the contrast images. First to anatomical and then to the target</span>
<span class="n">warpall</span> <span class="o">=</span> <span class="n">MapNode</span><span class="p">(</span><span class="n">ApplyTransforms</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s1">&#39;--float&#39;</span><span class="p">,</span>
                                  <span class="n">input_image_type</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                  <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;Linear&#39;</span><span class="p">,</span>
                                  <span class="n">invert_transform_flags</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
                                  <span class="n">num_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">reference_image</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
                                  <span class="n">terminal_output</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">),</span>
                  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;warpall&#39;</span><span class="p">,</span> <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;input_image&#39;</span><span class="p">])</span>

<span class="c1"># Transform the mean image. First to anatomical and then to the target</span>
<span class="n">warpmean</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">ApplyTransforms</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s1">&#39;--float&#39;</span><span class="p">,</span>
                                <span class="n">input_image_type</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;Linear&#39;</span><span class="p">,</span>
                                <span class="n">invert_transform_flags</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
                                <span class="n">num_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">reference_image</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
                                <span class="n">terminal_output</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;warpmean&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A very important difference between the partial and the complete approach is that the parameter <code class="docutils literal notranslate"><span class="pre">invert_transform_flags</span></code> of the <code class="docutils literal notranslate"><span class="pre">ApplyTransforms</span></code> has two values in the case where we have two transformation matrices and only one value where we have only one transformation. If this is not accounted for than you get the following error: <code class="docutils literal notranslate"><span class="pre">ERROR:</span> <span class="pre">The</span> <span class="pre">useInverse</span> <span class="pre">list</span> <span class="pre">must</span> <span class="pre">have</span> <span class="pre">the</span> <span class="pre">same</span> <span class="pre">number</span> <span class="pre">of</span> <span class="pre">entries</span> <span class="pre">as</span> <span class="pre">the</span> <span class="pre">transformsFileName</span> <span class="pre">list</span></code>.</p>
</div>
</div>
</div>
<div class="section" id="create-the-pipeline-and-connect-nodes-to-it">
<h3>Create the pipeline and connect nodes to it<a class="headerlink" href="#create-the-pipeline-and-connect-nodes-to-it" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Initiation of the ANTS normalization workflow</span>
<span class="n">normflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;normflow&#39;</span><span class="p">)</span>
<span class="n">normflow</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">experiment_dir</span><span class="p">,</span> <span class="n">working_dir</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>For the <strong>partial transformation</strong> use the following code:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Connect up ANTS normalization components</span>
<span class="n">normflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">antsreg</span><span class="p">,</span> <span class="n">apply2con</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;composite_transform&#39;</span><span class="p">,</span> <span class="s1">&#39;transforms&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">antsreg</span><span class="p">,</span> <span class="n">apply2mean</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;composite_transform&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;transforms&#39;</span><span class="p">)])</span>
                  <span class="p">])</span>
</pre></div>
</td></tr></table></div>
<p>For the <strong>complete transformation</strong> use the following code:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Connect up ANTS normalization components</span>
<span class="n">normflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">fssource</span><span class="p">,</span> <span class="n">convert2nii</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;T1&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">convert2nii</span><span class="p">,</span> <span class="n">convert2itk</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;reference_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">bbregister</span><span class="p">,</span> <span class="n">convert2itk</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_fsl_file&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;transform_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">convert2itk</span><span class="p">,</span> <span class="n">merge</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;itk_transform&#39;</span><span class="p">,</span> <span class="s1">&#39;in2&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">antsreg</span><span class="p">,</span> <span class="n">merge</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;composite_transform&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;in1&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">merge</span><span class="p">,</span> <span class="n">warpmean</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;transforms&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">merge</span><span class="p">,</span> <span class="n">warpall</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;transforms&#39;</span><span class="p">)]),</span>
                  <span class="p">])</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="establish-input-output-stream">
<h3>Establish Input &amp; Output Stream<a class="headerlink" href="#establish-input-output-stream" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Infosource - a function free node to iterate over the list of subject names</span>
<span class="n">infosource</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">]),</span>
                  <span class="n">name</span><span class="o">=</span><span class="s2">&quot;infosource&quot;</span><span class="p">)</span>
<span class="n">infosource</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">subject_list</span><span class="p">)]</span>

<span class="c1"># SelectFiles - to grab the data (alternativ to DataGrabber)</span>
<span class="n">anat_file</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="s1">&#39;freesurfer&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{subject_id}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;mri/brain.mgz&#39;</span><span class="p">)</span>
<span class="n">func_file</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">input_dir_1st</span><span class="p">,</span> <span class="s1">&#39;contrasts&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{subject_id}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;_mriconvert*/*_out.nii.gz&#39;</span><span class="p">)</span>
<span class="n">func_orig_file</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">input_dir_1st</span><span class="p">,</span> <span class="s1">&#39;contrasts&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{subject_id}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;[ce]*.nii&#39;</span><span class="p">)</span>
<span class="n">mean_file</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">input_dir_1st</span><span class="p">,</span> <span class="s1">&#39;preprocout&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{subject_id}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;mean*.nii&#39;</span><span class="p">)</span>

<span class="n">templates</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;anat&#39;</span><span class="p">:</span> <span class="n">anat_file</span><span class="p">,</span>
             <span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">func_file</span><span class="p">,</span>
             <span class="s1">&#39;func_orig&#39;</span><span class="p">:</span> <span class="n">func_orig_file</span><span class="p">,</span>
             <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">mean_file</span><span class="p">,</span>
             <span class="p">}</span>

<span class="n">selectfiles</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">SelectFiles</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span>
                               <span class="n">base_directory</span><span class="o">=</span><span class="n">experiment_dir</span><span class="p">),</span>
                   <span class="n">name</span><span class="o">=</span><span class="s2">&quot;selectfiles&quot;</span><span class="p">)</span>

<span class="c1"># Datasink - creates output folder for important outputs</span>
<span class="n">datasink</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">DataSink</span><span class="p">(</span><span class="n">base_directory</span><span class="o">=</span><span class="n">experiment_dir</span><span class="p">,</span>
                         <span class="n">container</span><span class="o">=</span><span class="n">output_dir</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;datasink&quot;</span><span class="p">)</span>

<span class="c1"># Use the following DataSink output substitutions</span>
<span class="n">substitutions</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;_subject_id_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;_apply2con&#39;</span><span class="p">,</span> <span class="s1">&#39;apply2con&#39;</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;_warpall&#39;</span><span class="p">,</span> <span class="s1">&#39;warpall&#39;</span><span class="p">)]</span>
<span class="n">datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">substitutions</span> <span class="o">=</span> <span class="n">substitutions</span>
</pre></div>
</td></tr></table></div>
<p>For the <strong>partial transformation</strong> use the following code:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Connect SelectFiles and DataSink to the workflow</span>
<span class="n">normflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">infosource</span><span class="p">,</span> <span class="n">selectfiles</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">selectfiles</span><span class="p">,</span> <span class="n">apply2con</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">selectfiles</span><span class="p">,</span> <span class="n">apply2mean</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">selectfiles</span><span class="p">,</span> <span class="n">antsreg</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;anat&#39;</span><span class="p">,</span> <span class="s1">&#39;moving_image&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">antsreg</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;warped_image&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;antsreg.@warped_image&#39;</span><span class="p">),</span>
                                       <span class="p">(</span><span class="s1">&#39;inverse_warped_image&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;antsreg.@inverse_warped_image&#39;</span><span class="p">),</span>
                                       <span class="p">(</span><span class="s1">&#39;composite_transform&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;antsreg.@transform&#39;</span><span class="p">),</span>
                                       <span class="p">(</span><span class="s1">&#39;inverse_composite_transform&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;antsreg.@inverse_transform&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">apply2con</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;output_image&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;warp_partial.@con&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">apply2mean</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;output_image&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;warp_partial.@mean&#39;</span><span class="p">)]),</span>
                  <span class="p">])</span>
</pre></div>
</td></tr></table></div>
<p>For the <strong>complete transformation</strong> use the following code:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Connect SelectFiles and DataSink to the workflow</span>
<span class="n">normflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">infosource</span><span class="p">,</span> <span class="n">selectfiles</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="n">fssource</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="n">bbregister</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">selectfiles</span><span class="p">,</span> <span class="n">bbregister</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;source_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">selectfiles</span><span class="p">,</span> <span class="n">antsreg</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;anat&#39;</span><span class="p">,</span> <span class="s1">&#39;moving_image&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">selectfiles</span><span class="p">,</span> <span class="n">convert2itk</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;source_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">selectfiles</span><span class="p">,</span> <span class="n">warpall</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;func_orig&#39;</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">selectfiles</span><span class="p">,</span> <span class="n">warpmean</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">antsreg</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;warped_image&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;antsreg.@warped_image&#39;</span><span class="p">),</span>
                                       <span class="p">(</span><span class="s1">&#39;inverse_warped_image&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;antsreg.@inverse_warped_image&#39;</span><span class="p">),</span>
                                       <span class="p">(</span><span class="s1">&#39;composite_transform&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;antsreg.@transform&#39;</span><span class="p">),</span>
                                       <span class="p">(</span><span class="s1">&#39;inverse_composite_transform&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;antsreg.@inverse_transform&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">warpall</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;output_image&#39;</span><span class="p">,</span> <span class="s1">&#39;warp_complete.@warpall&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">warpmean</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;output_image&#39;</span><span class="p">,</span> <span class="s1">&#39;warp_complete.@warpmean&#39;</span><span class="p">)]),</span>
                  <span class="p">])</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="run-the-pipeline-and-generate-the-graphs">
<h3>Run the pipeline and generate the graphs<a class="headerlink" href="#run-the-pipeline-and-generate-the-graphs" title="Permalink to this headline">¶</a></h3>
<p>Now, let’s run the workflow with the following code:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">normflow</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph2use</span><span class="o">=</span><span class="s1">&#39;colored&#39;</span><span class="p">)</span>
<span class="n">normflow</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;MultiProc&#39;</span><span class="p">,</span> <span class="n">plugin_args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;n_procs&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>
</pre></div>
</td></tr></table></div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>You can download the code for the partial and complete normalization with ANTS as a script here: <a class="reference external" href="https://github.com/miykael/nipype-beginner-s-guide/blob/master/scripts/example_fMRI_2_normalize_ANTS_complete.py">example_fMRI_2_normalize_ANTS_complete.py</a> or <a class="reference external" href="https://github.com/miykael/nipype-beginner-s-guide/blob/master/scripts/example_fMRI_2_normalize_ANTS_partial.py">example_fMRI_2_normalize_ANTS_partial.py</a></p>
</div>
</div>
<div class="section" id="visualize-the-workflow">
<h3>Visualize the workflow<a class="headerlink" href="#visualize-the-workflow" title="Permalink to this headline">¶</a></h3>
<p>The colored graph of the <strong>partial</strong>  normalization workflow looks as follows:</p>
<a class="reference internal image-reference" href="_images/norm_ants_colored_partial.png"><img alt="_images/norm_ants_colored_partial.png" class="align-center" src="_images/norm_ants_colored_partial.png" style="width: 350pt;" /></a>
<p>The colored graph of the <strong>complete</strong>  normalization workflow looks as follows:</p>
<img alt="_images/norm_ants_colored_complete.png" class="align-center" src="_images/norm_ants_colored_complete.png" />
</div>
<div class="section" id="resulting-folder-structure">
<h3>Resulting Folder Structure<a class="headerlink" href="#resulting-folder-structure" title="Permalink to this headline">¶</a></h3>
<p>The resulting folder structure looks for the <strong>partial</strong> and <strong>complete</strong> approach combined as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>output_fMRI_example_norm_ants/
<span class="p">|</span>-- antsreg
<span class="p">|</span>   <span class="p">|</span>-- sub001
<span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- transformComposite.h5
<span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- transformInverseComposite.h5
<span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- transform_InverseWarped.nii.gz
<span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- transform_Warped.nii.gz
<span class="p">|</span>   <span class="p">|</span>-- sub0..
<span class="p">|</span>   <span class="p">|</span>-- sub010
<span class="p">|</span>-- warp_partial
<span class="p">|</span>   <span class="p">|</span>-- sub001
<span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- apply2con0
<span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- con_0001_out_trans.nii.gz
<span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- apply2con1
<span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- con_0002_out_trans.nii.gz
<span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- apply2con2
<span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- con_0003_out_trans.nii.gz
<span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- apply2con3
<span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- con_0004_out_trans.nii.gz
<span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- apply2con4
<span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- ess_0005_out_trans.nii.gz
<span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- apply2con5
<span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- ess_0006_out_trans.nii.gz
<span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- meanarun001_trans.nii
<span class="p">|</span>   <span class="p">|</span>-- sub0..
<span class="p">|</span>   <span class="p">|</span>-- sub010
<span class="p">|</span>-- warp_complete
    <span class="p">|</span>-- sub001
    <span class="p">|</span>   <span class="p">|</span>-- meanarun001_trans.nii
    <span class="p">|</span>   <span class="p">|</span>-- warpall0
    <span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- con_0001_trans.nii
    <span class="p">|</span>   <span class="p">|</span>-- warpall1
    <span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- con_0002_trans.nii
    <span class="p">|</span>   <span class="p">|</span>-- warpall2
    <span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- con_0003_trans.nii
    <span class="p">|</span>   <span class="p">|</span>-- warpall3
    <span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- con_0004_trans.nii
    <span class="p">|</span>   <span class="p">|</span>-- warpall4
    <span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- ess_0005_trans.nii
    <span class="p">|</span>   <span class="p">|</span>-- warpall5
    <span class="p">|</span>       <span class="p">|</span>-- ess_0006_trans.nii
    <span class="p">|</span>-- sub0..
    <span class="p">|</span>-- sub010
</pre></div>
</div>
</div>
</div>
<div class="section" id="normalize-your-data-with-spm12">
<h2>Normalize Your Data with SPM12<a class="headerlink" href="#normalize-your-data-with-spm12" title="Permalink to this headline">¶</a></h2>
<p>The normalization of your data with SPM12 is much simpler than the one with ANTs. We only need to feed all the necessary inputs to a node called <code class="docutils literal notranslate"><span class="pre">Normalize12</span></code>.</p>
<div class="section" id="id1">
<h3>Import modules and specify interface behaviors<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>As always, let’s import necessary modules and tell the system where to find MATLAB.</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Import modules</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">opj</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.spm</span> <span class="kn">import</span> <span class="n">Normalize12</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.utility</span> <span class="kn">import</span> <span class="n">IdentityInterface</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.io</span> <span class="kn">import</span> <span class="n">SelectFiles</span><span class="p">,</span> <span class="n">DataSink</span>
<span class="kn">from</span> <span class="nn">nipype.algorithms.misc</span> <span class="kn">import</span> <span class="n">Gunzip</span>
<span class="kn">from</span> <span class="nn">nipype.pipeline.engine</span> <span class="kn">import</span> <span class="n">Workflow</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">MapNode</span>

<span class="c1"># Specification to MATLAB</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.matlab</span> <span class="kn">import</span> <span class="n">MatlabCommand</span>
<span class="n">MatlabCommand</span><span class="o">.</span><span class="n">set_default_paths</span><span class="p">(</span><span class="s1">&#39;/usr/local/MATLAB/R2014a/toolbox/spm12&#39;</span><span class="p">)</span>
<span class="n">MatlabCommand</span><span class="o">.</span><span class="n">set_default_matlab_cmd</span><span class="p">(</span><span class="s2">&quot;matlab -nodesktop -nosplash&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id2">
<h3>Define experiment specific parameters<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Specify variables</span>
<span class="n">experiment_dir</span> <span class="o">=</span> <span class="s1">&#39;~/nipype_tutorial&#39;</span>         <span class="c1"># location of experiment folder</span>
<span class="n">input_dir_1st</span> <span class="o">=</span> <span class="s1">&#39;output_fMRI_example_1st&#39;</span>    <span class="c1"># name of 1st-level output folder</span>
<span class="n">output_dir</span> <span class="o">=</span> <span class="s1">&#39;output_fMRI_example_norm_spm&#39;</span>  <span class="c1"># name of norm output folder</span>
<span class="n">working_dir</span> <span class="o">=</span> <span class="s1">&#39;workingdir_fMRI_example_norm_spm&#39;</span>  <span class="c1"># name of working directory</span>
<span class="n">subject_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sub001&#39;</span><span class="p">,</span> <span class="s1">&#39;sub002&#39;</span><span class="p">,</span> <span class="s1">&#39;sub003&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sub004&#39;</span><span class="p">,</span> <span class="s1">&#39;sub005&#39;</span><span class="p">,</span> <span class="s1">&#39;sub006&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sub007&#39;</span><span class="p">,</span> <span class="s1">&#39;sub008&#39;</span><span class="p">,</span> <span class="s1">&#39;sub009&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sub010&#39;</span><span class="p">]</span>                    <span class="c1"># list of subject identifiers</span>

<span class="c1"># location of template in form of a tissue probability map to normalize to</span>
<span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;/usr/local/MATLAB/R2014a/toolbox/spm12/tpm/TPM.nii&#39;</span>
</pre></div>
</td></tr></table></div>
<p>It’s important to note that SPM12 provides its own template <code class="docutils literal notranslate"><span class="pre">TMP.nii</span></code> to which the data will be normalized to.</p>
</div>
<div class="section" id="id3">
<h3>Create nodes<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>The functional and anatomical data that we want to normalize is in compressed ZIP format, which SPM12 can’t handle. Therefore we first have to unzip those files with <code class="docutils literal notranslate"><span class="pre">Gunzip</span></code>, before we can feed those files to SPM’s <code class="docutils literal notranslate"><span class="pre">Normalize12</span></code> node.</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Gunzip - unzip the structural image</span>
<span class="n">gunzip_struct</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">Gunzip</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;gunzip_struct&quot;</span><span class="p">)</span>

<span class="c1"># Gunzip - unzip the contrast image</span>
<span class="n">gunzip_con</span> <span class="o">=</span> <span class="n">MapNode</span><span class="p">(</span><span class="n">Gunzip</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;gunzip_con&quot;</span><span class="p">,</span>
                     <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">])</span>

<span class="c1"># Normalize - normalizes functional and structural images to the MNI template</span>
<span class="n">normalize</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">Normalize12</span><span class="p">(</span><span class="n">jobtype</span><span class="o">=</span><span class="s1">&#39;estwrite&#39;</span><span class="p">,</span>
                             <span class="n">tpm</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
                             <span class="n">write_voxel_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                 <span class="n">name</span><span class="o">=</span><span class="s2">&quot;normalize&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id4">
<h3>Create the pipeline and connect nodes to it<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Specify Normalization-Workflow &amp; Connect Nodes</span>
<span class="n">normflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;normflow&#39;</span><span class="p">)</span>
<span class="n">normflow</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">experiment_dir</span><span class="p">,</span> <span class="n">working_dir</span><span class="p">)</span>

<span class="c1"># Connect up ANTS normalization components</span>
<span class="n">normflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">gunzip_struct</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;image_to_align&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">gunzip_con</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;apply_to_files&#39;</span><span class="p">)]),</span>
                  <span class="p">])</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id5">
<h3>Establish Input &amp; Output Stream<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Infosource - a function free node to iterate over the list of subject names</span>
<span class="n">infosource</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">]),</span>
                  <span class="n">name</span><span class="o">=</span><span class="s2">&quot;infosource&quot;</span><span class="p">)</span>
<span class="n">infosource</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">subject_list</span><span class="p">)]</span>

<span class="c1"># SelectFiles - to grab the data (alternativ to DataGrabber)</span>
<span class="n">anat_file</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{subject_id}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;struct.nii.gz&#39;</span><span class="p">)</span>
<span class="n">con_file</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">input_dir_1st</span><span class="p">,</span> <span class="s1">&#39;contrasts&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{subject_id}</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;_mriconvert*/*_out.nii.gz&#39;</span><span class="p">)</span>
<span class="n">templates</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;anat&#39;</span><span class="p">:</span> <span class="n">anat_file</span><span class="p">,</span>
             <span class="s1">&#39;con&#39;</span><span class="p">:</span> <span class="n">con_file</span><span class="p">,</span>
             <span class="p">}</span>
<span class="n">selectfiles</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">SelectFiles</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span>
                               <span class="n">base_directory</span><span class="o">=</span><span class="n">experiment_dir</span><span class="p">),</span>
                   <span class="n">name</span><span class="o">=</span><span class="s2">&quot;selectfiles&quot;</span><span class="p">)</span>

<span class="c1"># Datasink - creates output folder for important outputs</span>
<span class="n">datasink</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">DataSink</span><span class="p">(</span><span class="n">base_directory</span><span class="o">=</span><span class="n">experiment_dir</span><span class="p">,</span>
                         <span class="n">container</span><span class="o">=</span><span class="n">output_dir</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;datasink&quot;</span><span class="p">)</span>

<span class="c1"># Use the following DataSink output substitutions</span>
<span class="n">substitutions</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;_subject_id_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span>
<span class="n">datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">substitutions</span> <span class="o">=</span> <span class="n">substitutions</span>

<span class="c1"># Connect SelectFiles and DataSink to the workflow</span>
<span class="n">normflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">infosource</span><span class="p">,</span> <span class="n">selectfiles</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">selectfiles</span><span class="p">,</span> <span class="n">gunzip_struct</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;anat&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">selectfiles</span><span class="p">,</span> <span class="n">gunzip_con</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;con&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">normalize</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;normalized_files&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;normalized.@files&#39;</span><span class="p">),</span>
                                         <span class="p">(</span><span class="s1">&#39;normalized_image&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;normalized.@image&#39;</span><span class="p">),</span>
                                         <span class="p">(</span><span class="s1">&#39;deformation_field&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;normalized.@field&#39;</span><span class="p">),</span>
                                         <span class="p">]),</span>
                  <span class="p">])</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id6">
<h3>Run the pipeline and generate the graphs<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>Now, let’s run the workflow with the following code:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">normflow</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph2use</span><span class="o">=</span><span class="s1">&#39;colored&#39;</span><span class="p">)</span>
<span class="n">normflow</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;MultiProc&#39;</span><span class="p">,</span> <span class="n">plugin_args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;n_procs&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>
</pre></div>
</td></tr></table></div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>You can download the code for the normalization with SPM12 as a script here: <a class="reference external" href="https://github.com/miykael/nipype-beginner-s-guide/blob/master/scripts/example_fMRI_2_normalize_SPM.py">example_fMRI_2_normalize_SPM.py</a></p>
</div>
</div>
<div class="section" id="id7">
<h3>Visualize the workflow<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>The colored graph of this normalization workflow looks as follows:</p>
<a class="reference internal image-reference" href="_images/norm_spm_colored.png"><img alt="_images/norm_spm_colored.png" class="align-center" src="_images/norm_spm_colored.png" style="width: 325pt;" /></a>
</div>
<div class="section" id="id8">
<h3>Resulting Folder Structure<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>The resulting folder structure looks as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>output_fMRI_example_norm_spm/
<span class="p">|</span>-- normalized
    <span class="p">|</span>-- sub001
    <span class="p">|</span>   <span class="p">|</span>-- wcon_0001_out.nii
    <span class="p">|</span>   <span class="p">|</span>-- wcon_0002_out.nii
    <span class="p">|</span>   <span class="p">|</span>-- wcon_0003_out.nii
    <span class="p">|</span>   <span class="p">|</span>-- wcon_0004_out.nii
    <span class="p">|</span>   <span class="p">|</span>-- wess_0005_out.nii
    <span class="p">|</span>   <span class="p">|</span>-- wess_0006_out.nii
    <span class="p">|</span>   <span class="p">|</span>-- wstruct.nii
    <span class="p">|</span>   <span class="p">|</span>-- y_struct.nii
    <span class="p">|</span>-- sub0..
    <span class="p">|</span>-- sub010
</pre></div>
</div>
</div>
</div>
</div>



          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="secondLevel.html" title="How To Build A Pipeline For A Second Level fMRI Analysis"
             >next</a></li>
        <li class="right" >
          <a href="firstLevel.html" title="How To Build A Pipeline For A First Level fMRI Analysis"
             >previous</a> |</li>
        <li><a href="index.html">Home</a>|</li>
        <li><a href="http://miykael.github.com/nipype-beginner-s-guide/tableofcontent.html">Table of Contents</a>|</li>
        <li><a href="http://miykael.github.com/nipype-beginner-s-guide/faq.html">FAQ</a>|</li>
        <li><a href="http://miykael.github.com/nipype-beginner-s-guide/glossary.html">Glossary</a>|</li>
        <li><a href="https://github.com/miykael/nipype-beginner-s-guide/">github</a>|</li>
        <li><a href="http://nipy.org/nipype/">Nipype</a>|</li>
        <li><a href="http://miykael.github.io/nipype-beginner-s-guide/help.html">Help</a>|</li> 
      </ul>
    </div>
    <div class="footer">
    <p>
        &copy; Copyright 2016, Michael Notter.
      Last updated on June 10, 2021.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 3.2.1.
    </p>
    <p>
    This page uses <a href="http://analytics.google.com/">Google Analytics</a> to collect statistics. You can disable it by blocking the JavaScript coming from www.google-analytics.com.
    </p>
    </div>
  </body>
</html>