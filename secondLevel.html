<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Nipype Beginner&#39;s Guide &mdash; All you need to know to become an expert in Nipype</title>
    
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="search" title="Search" href="search.html" />
    <link rel="top" title="All you need to know to become an expert in Nipype" href="index.html" />
    <link rel="next" title="Help &amp; Support" href="help.html" />
    <link rel="prev" title="How To Normalize Your Data" href="normalize.html" />
    <meta name="keywords" content="nipype, neuroimaging, pipeline, workflow, parallel, python, neuroscience, python, guide, mri, fmri, dti, tutorial, user guide">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-24958678-1', 'auto');
      ga('send', 'pageview');

    </script>

  </head>
  <body>

    <div class="headertext" >
     <a href="index.html">
        Nipype Beginner's Guide</a>
    </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="help.html" title="Help &amp; Support"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="normalize.html" title="How To Normalize Your Data"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Home</a>|</li>
        <li><a href="http://miykael.github.com/nipype-beginner-s-guide/tableofcontent.html">Table of Contents</a>|</li>
        <li><a href="http://miykael.github.com/nipype-beginner-s-guide/faq.html">FAQ</a>|</li>
        <li><a href="http://miykael.github.com/nipype-beginner-s-guide/glossary.html">Glossary</a>|</li>
        <li><a href="https://github.com/miykael/nipype-beginner-s-guide/">github</a>|</li>
        <li><a href="http://nipy.org/nipype/">Nipype</a>|</li>
        <li><a href="http://miykael.github.io/nipype-beginner-s-guide/help.html">Help</a>|</li> 
      </ul>
    </div>
  
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/nipype-beginners-guide-html_logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">How To Build A Pipeline For A Second Level fMRI Analysis</a><ul>
<li><a class="reference internal" href="#write-your-pipeline-script">Write your pipeline script</a><ul>
<li><a class="reference internal" href="#import-modules-and-specify-interface-behaviors">Import modules and specify interface behaviors</a></li>
<li><a class="reference internal" href="#define-experiment-specific-parameters">Define experiment specific parameters</a></li>
<li><a class="reference internal" href="#create-nodes">Create nodes</a></li>
<li><a class="reference internal" href="#create-the-pipeline-and-connect-nodes-to-it">Create the pipeline and connect nodes to it</a></li>
<li><a class="reference internal" href="#establish-input-output-stream">Establish Input &amp; Output Stream</a></li>
<li><a class="reference internal" href="#run-the-pipeline-and-generate-the-graph">Run the pipeline and generate the graph</a></li>
</ul>
</li>
<li><a class="reference internal" href="#visualize-your-pipeline">Visualize your pipeline</a></li>
<li><a class="reference internal" href="#resulting-folder-structure">Resulting Folder Structure</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="normalize.html"
                        title="previous chapter">How To Normalize Your Data</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="help.html"
                        title="next chapter">Help &amp; Support</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/secondLevel.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
        </div>
      </div>
    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">

            
  <div class="admonition important">
<p class="admonition-title">Important</p>
<p>This guide hasn’t been updated since January 2017 and is based on an older version of Nipype. The code in this guide is not tested against newer Nipype versions and might not work anymore. For a newer, more up to date and better introduction to Nipype, please check out the the <a class="reference external" href="https://miykael.github.io/nipype_tutorial/">Nipype Tutorial</a>.</p>
</div>
<div class="section" id="how-to-build-a-pipeline-for-a-second-level-fmri-analysis">
<h1>How To Build A Pipeline For A Second Level fMRI Analysis<a class="headerlink" href="#how-to-build-a-pipeline-for-a-second-level-fmri-analysis" title="Permalink to this headline">¶</a></h1>
<p>In this section you will learn how to create a workflow that does a <strong>second level analysis</strong> on fMRI data. There are again multiple ways how you can do this, but the most simple on is to check if your contrasts from the first level analysis are still significant on the group-level a.k.a. the 2nd level.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can only do a <strong>second level analysis</strong> if you already have done a first level analysis, obviously! But more importantly, those first level contrasts have to be in a common reference space. Otherwise there is now way of actually comparing them with each other and getting a valid results from them. Luckily, if you’ve done the previous step, you’ve already normalized your data (either with ANTs or SPM) to a template.</p>
</div>
<div class="section" id="write-your-pipeline-script">
<h2>Write your pipeline script<a class="headerlink" href="#write-your-pipeline-script" title="Permalink to this headline">¶</a></h2>
<p>If you’ve already done the previous sections, you know how this works. We first import necessary modules, define experiment specific parameters, create nodes, create a workflow and connect the nodes to it, we create an I/O stream and connect it to the workflow and finally run this workflow.</p>
<div class="section" id="import-modules-and-specify-interface-behaviors">
<h3>Import modules and specify interface behaviors<a class="headerlink" href="#import-modules-and-specify-interface-behaviors" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">opj</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.io</span> <span class="kn">import</span> <span class="n">SelectFiles</span><span class="p">,</span> <span class="n">DataSink</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.spm</span> <span class="kn">import</span> <span class="p">(</span><span class="n">OneSampleTTestDesign</span><span class="p">,</span> <span class="n">EstimateModel</span><span class="p">,</span>
                                   <span class="n">EstimateContrast</span><span class="p">,</span> <span class="n">Threshold</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.utility</span> <span class="kn">import</span> <span class="n">IdentityInterface</span>
<span class="kn">from</span> <span class="nn">nipype.pipeline.engine</span> <span class="kn">import</span> <span class="n">Workflow</span><span class="p">,</span> <span class="n">Node</span>

<span class="c1"># Specification to MATLAB</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.matlab</span> <span class="kn">import</span> <span class="n">MatlabCommand</span>
<span class="n">MatlabCommand</span><span class="o">.</span><span class="n">set_default_paths</span><span class="p">(</span><span class="s1">&#39;/usr/local/MATLAB/R2014a/toolbox/spm12&#39;</span><span class="p">)</span>
<span class="n">MatlabCommand</span><span class="o">.</span><span class="n">set_default_matlab_cmd</span><span class="p">(</span><span class="s2">&quot;matlab -nodesktop -nosplash&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="define-experiment-specific-parameters">
<h3>Define experiment specific parameters<a class="headerlink" href="#define-experiment-specific-parameters" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">experiment_dir</span> <span class="o">=</span> <span class="s1">&#39;~/nipype_tutorial&#39;</span>            <span class="c1"># location of experiment folder</span>
<span class="n">output_dir</span> <span class="o">=</span> <span class="s1">&#39;output_fMRI_example_2nd_ants&#39;</span>     <span class="c1"># name of 2nd-level output folder</span>
<span class="n">input_dir_norm</span> <span class="o">=</span> <span class="s1">&#39;output_fMRI_example_norm_ants&#39;</span><span class="c1"># name of norm output folder</span>
<span class="n">working_dir</span> <span class="o">=</span> <span class="s1">&#39;workingdir_fMRI_example_2nd_ants&#39;</span><span class="c1"># name of working directory</span>
<span class="n">subject_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sub001&#39;</span><span class="p">,</span> <span class="s1">&#39;sub002&#39;</span><span class="p">,</span> <span class="s1">&#39;sub003&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sub004&#39;</span><span class="p">,</span> <span class="s1">&#39;sub005&#39;</span><span class="p">,</span> <span class="s1">&#39;sub006&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sub007&#39;</span><span class="p">,</span> <span class="s1">&#39;sub008&#39;</span><span class="p">,</span> <span class="s1">&#39;sub009&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sub010&#39;</span><span class="p">]</span>                       <span class="c1"># list of subject identifiers</span>
<span class="n">contrast_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;con_0001&#39;</span><span class="p">,</span> <span class="s1">&#39;con_0002&#39;</span><span class="p">,</span> <span class="s1">&#39;con_0003&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;con_0004&#39;</span><span class="p">,</span> <span class="s1">&#39;ess_0005&#39;</span><span class="p">,</span> <span class="s1">&#39;ess_0006&#39;</span><span class="p">]</span> <span class="c1"># list of contrast identifiers</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pay attention to the name of the <code class="docutils literal notranslate"><span class="pre">input_dir_norm</span></code>. Depending on the way you normalized your data, ANTs or SPM, the folder name has either the ending <code class="docutils literal notranslate"><span class="pre">_ants</span></code> or <code class="docutils literal notranslate"><span class="pre">_spm</span></code>.</p>
</div>
</div>
<div class="section" id="create-nodes">
<h3>Create nodes<a class="headerlink" href="#create-nodes" title="Permalink to this headline">¶</a></h3>
<p>We don’t need many nodes for a simple second level analysis. In fact they are the same as the ones we used for the first level analysis. We create a simple T-Test, estimate it and look at a simple mean contrast, i.e. a contrast that shows what the group mean activation of a certain first level contrast is.</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># One Sample T-Test Design - creates one sample T-Test Design</span>
<span class="n">onesamplettestdes</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">OneSampleTTestDesign</span><span class="p">(),</span>
                         <span class="n">name</span><span class="o">=</span><span class="s2">&quot;onesampttestdes&quot;</span><span class="p">)</span>

<span class="c1"># EstimateModel - estimate the parameters of the model</span>
<span class="n">level2estimate</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">EstimateModel</span><span class="p">(</span><span class="n">estimation_method</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Classical&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}),</span>
                      <span class="n">name</span><span class="o">=</span><span class="s2">&quot;level2estimate&quot;</span><span class="p">)</span>

<span class="c1"># EstimateContrast - estimates simple group contrast</span>
<span class="n">level2conestimate</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">EstimateContrast</span><span class="p">(</span><span class="n">group_contrast</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                         <span class="n">name</span><span class="o">=</span><span class="s2">&quot;level2conestimate&quot;</span><span class="p">)</span>
<span class="n">cont1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">level2conestimate</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">contrasts</span> <span class="o">=</span> <span class="p">[</span><span class="n">cont1</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="create-the-pipeline-and-connect-nodes-to-it">
<h3>Create the pipeline and connect nodes to it<a class="headerlink" href="#create-the-pipeline-and-connect-nodes-to-it" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Specify 2nd-Level Analysis Workflow &amp; Connect Nodes</span>
<span class="n">l2analysis</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;l2analysis&#39;</span><span class="p">)</span>
<span class="n">l2analysis</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">experiment_dir</span><span class="p">,</span> <span class="n">working_dir</span><span class="p">)</span>

<span class="c1"># Connect up the 2nd-level analysis components</span>
<span class="n">l2analysis</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">onesamplettestdes</span><span class="p">,</span> <span class="n">level2estimate</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;spm_mat_file&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;spm_mat_file&#39;</span><span class="p">)]</span> <span class="p">),</span>
                    <span class="p">(</span><span class="n">level2estimate</span><span class="p">,</span> <span class="n">level2conestimate</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;spm_mat_file&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;spm_mat_file&#39;</span><span class="p">),</span>
                                                         <span class="p">(</span><span class="s1">&#39;beta_images&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;beta_images&#39;</span><span class="p">),</span>
                                                         <span class="p">(</span><span class="s1">&#39;residual_image&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;residual_image&#39;</span><span class="p">)]),</span>
                    <span class="p">])</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="establish-input-output-stream">
<h3>Establish Input &amp; Output Stream<a class="headerlink" href="#establish-input-output-stream" title="Permalink to this headline">¶</a></h3>
<p>The creation of the I/O stream is as usual. But because I showed you three ways to normalize your data in the previous section, be aware that you have to point the <code class="docutils literal notranslate"><span class="pre">SelectFiles</span></code> node to the right input folder. Your option for the <code class="docutils literal notranslate"><span class="pre">SelectFiles</span></code> input template are as follows:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># contrast template for ANTs normalization (complete)</span>
<span class="n">con_file</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">input_dir_norm</span><span class="p">,</span> <span class="s1">&#39;warp_complete&#39;</span><span class="p">,</span> <span class="s1">&#39;sub*&#39;</span><span class="p">,</span> <span class="s1">&#39;warpall*&#39;</span><span class="p">,</span>
               <span class="s1">&#39;</span><span class="si">{contrast_id}</span><span class="s1">_trans.nii&#39;</span><span class="p">)</span>

<span class="c1"># contrast template for ANTs normalization (partial)</span>
<span class="n">con_file</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">input_dir_norm</span><span class="p">,</span> <span class="s1">&#39;warp_partial&#39;</span><span class="p">,</span> <span class="s1">&#39;sub*&#39;</span><span class="p">,</span> <span class="s1">&#39;apply2con*&#39;</span><span class="p">,</span>
               <span class="s1">&#39;</span><span class="si">{contrast_id}</span><span class="s1">_out_trans.nii.gz&#39;</span><span class="p">)</span>

<span class="c1"># contrast template for SPM normalization</span>
<span class="n">con_file</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">input_dir_norm</span><span class="p">,</span> <span class="s1">&#39;normalized&#39;</span><span class="p">,</span> <span class="s1">&#39;sub*&#39;</span><span class="p">,</span>
               <span class="s1">&#39;*</span><span class="si">{contrast_id}</span><span class="s1">_out.nii&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is very important to notice that only contrast images (e.g. <code class="docutils literal notranslate"><span class="pre">con</span></code>-images) can be used for a second-level group analysis. It is statistically incorrect to use statistic images, such as <code class="docutils literal notranslate"><span class="pre">spmT</span></code>- or <code class="docutils literal notranslate"><span class="pre">spmF</span></code>-images.</p>
</div>
<p>The following example is adjusted for the situation where the normalization was done with ANTs. The code for the I/O stream looks as follows:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Infosource - a function free node to iterate over the list of subject names</span>
<span class="n">infosource</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;contrast_id&#39;</span><span class="p">]),</span>
                  <span class="n">name</span><span class="o">=</span><span class="s2">&quot;infosource&quot;</span><span class="p">)</span>
<span class="n">infosource</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;contrast_id&#39;</span><span class="p">,</span> <span class="n">contrast_list</span><span class="p">)]</span>

<span class="c1"># SelectFiles - to grab the data (alternative to DataGrabber)</span>
<span class="n">con_file</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">input_dir_norm</span><span class="p">,</span> <span class="s1">&#39;warp_complete&#39;</span><span class="p">,</span> <span class="s1">&#39;sub*&#39;</span><span class="p">,</span> <span class="s1">&#39;warpall*&#39;</span><span class="p">,</span>
               <span class="s1">&#39;</span><span class="si">{contrast_id}</span><span class="s1">_trans.nii&#39;</span><span class="p">)</span>
<span class="n">templates</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cons&#39;</span><span class="p">:</span> <span class="n">con_file</span><span class="p">}</span>

<span class="n">selectfiles</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">SelectFiles</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span>
                               <span class="n">base_directory</span><span class="o">=</span><span class="n">experiment_dir</span><span class="p">),</span>
                   <span class="n">name</span><span class="o">=</span><span class="s2">&quot;selectfiles&quot;</span><span class="p">)</span>

<span class="c1"># Datasink - creates output folder for important outputs</span>
<span class="n">datasink</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">DataSink</span><span class="p">(</span><span class="n">base_directory</span><span class="o">=</span><span class="n">experiment_dir</span><span class="p">,</span>
                         <span class="n">container</span><span class="o">=</span><span class="n">output_dir</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;datasink&quot;</span><span class="p">)</span>

<span class="c1"># Use the following DataSink output substitutions</span>
<span class="n">substitutions</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;_contrast_id_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span>
<span class="n">datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">substitutions</span> <span class="o">=</span> <span class="n">substitutions</span>

<span class="c1"># Connect SelectFiles and DataSink to the workflow</span>
<span class="n">l2analysis</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">infosource</span><span class="p">,</span> <span class="n">selectfiles</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;contrast_id&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;contrast_id&#39;</span><span class="p">)]),</span>
                    <span class="p">(</span><span class="n">selectfiles</span><span class="p">,</span> <span class="n">onesamplettestdes</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;cons&#39;</span><span class="p">,</span> <span class="s1">&#39;in_files&#39;</span><span class="p">)]),</span>
                    <span class="p">(</span><span class="n">level2conestimate</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;spm_mat_file&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;contrasts.@spm_mat&#39;</span><span class="p">),</span>
                                                   <span class="p">(</span><span class="s1">&#39;spmT_images&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;contrasts.@T&#39;</span><span class="p">),</span>
                                                   <span class="p">(</span><span class="s1">&#39;con_images&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;contrasts.@con&#39;</span><span class="p">)]),</span>
                    <span class="p">])</span>
</pre></div>
</td></tr></table></div>
<p>If you’ve normalized your data with ANTs but did only the so called <strong>partial</strong> approach, the code above will not work and crash with the following message:</p>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">Item</span> <span class="s">&#39;Scans&#39;,</span> <span class="s">field</span> <span class="s">&#39;val&#39;:</span> <span class="s">Number</span> <span class="s">of</span> <span class="s">matching</span> <span class="s">files</span> <span class="s">(0)</span> <span class="s">less</span> <span class="s">than</span> <span class="s">required</span> <span class="s">(1).</span>

<span class="n">Standard</span> <span class="s">error:</span>
<span class="n">MATLAB</span> <span class="s">code</span> <span class="s">threw</span> <span class="s">an</span> <span class="s">exception:</span>
<span class="k">...</span>
<span class="n">Name</span><span class="p">:</span><span class="n">pyscript_onesamplettestdesign</span>
<span class="k">...</span>
<span class="n">Interface</span> <span class="s">OneSampleTTestDesign</span> <span class="s">failed</span> <span class="s">to</span> <span class="s">run.</span>
</pre></div>
</td></tr></table></div>
<p>Such errors are sometimes hard to read. What this message means is that SPM’s <code class="docutils literal notranslate"><span class="pre">onesamplettestdes</span></code> tried to open an image-file but was only able to read out 0 scans, of the requested at least 1. This is a common message where SPM tries to read a zipped NIfTI file (ending with <code class="docutils literal notranslate"><span class="pre">nii.gz</span></code>) and cannot unpack it. To solve this issue we only need to insert an additional <code class="docutils literal notranslate"><span class="pre">Gunzip</span></code> node in our pipeline and redirect the workflow through this new gunzip node before it goes to the <code class="docutils literal notranslate"><span class="pre">onesamplettestdes</span></code> node. So the new code looks as follows:</p>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Gunzip - unzip the contrast image</span>
<span class="kn">from</span> <span class="nn">nipype.algorithms.misc</span> <span class="kn">import</span> <span class="n">Gunzip</span>
<span class="kn">from</span> <span class="nn">nipype.pipeline.engine</span> <span class="kn">import</span> <span class="n">MapNode</span>
<span class="n">gunzip_con</span> <span class="o">=</span> <span class="n">MapNode</span><span class="p">(</span><span class="n">Gunzip</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;gunzip_con&quot;</span><span class="p">,</span>
                     <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">])</span>

<span class="c1"># Connect SelectFiles and DataSink to the workflow</span>
<span class="n">l2analysis</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">infosource</span><span class="p">,</span> <span class="n">selectfiles</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;contrast_id&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;contrast_id&#39;</span><span class="p">)]),</span>
                    <span class="p">(</span><span class="n">selectfiles</span><span class="p">,</span> <span class="n">gunzip_con</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;cons&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
                    <span class="p">(</span><span class="n">gunzip_con</span><span class="p">,</span> <span class="n">onesamplettestdes</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;in_files&#39;</span><span class="p">)]),</span>
                    <span class="p">(</span><span class="n">level2conestimate</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;spm_mat_file&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;contrasts.@spm_mat&#39;</span><span class="p">),</span>
                                                   <span class="p">(</span><span class="s1">&#39;spmT_images&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;contrasts.@T&#39;</span><span class="p">),</span>
                                                   <span class="p">(</span><span class="s1">&#39;con_images&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;contrasts.@con&#39;</span><span class="p">)]),</span>
                    <span class="p">])</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="run-the-pipeline-and-generate-the-graph">
<h3>Run the pipeline and generate the graph<a class="headerlink" href="#run-the-pipeline-and-generate-the-graph" title="Permalink to this headline">¶</a></h3>
<div class="highlight-py notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">l2analysis</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph2use</span><span class="o">=</span><span class="s1">&#39;colored&#39;</span><span class="p">)</span>
<span class="n">l2analysis</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;MultiProc&#39;</span><span class="p">,</span> <span class="n">plugin_args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;n_procs&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>
</pre></div>
</td></tr></table></div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>You can download the code for this 2nd level pipeline as a script here: <a class="reference external" href="https://github.com/miykael/nipype-beginner-s-guide/blob/master/scripts/example_fMRI_3_second_level.py">example_fMRI_3_second_level.py</a></p>
</div>
</div>
</div>
<div class="section" id="visualize-your-pipeline">
<h2>Visualize your pipeline<a class="headerlink" href="#visualize-your-pipeline" title="Permalink to this headline">¶</a></h2>
<p>The colored graph of the 2nd-level workflow looks as follows:</p>
<a class="reference internal image-reference" href="_images/2nd_level_colored.png"><img alt="_images/2nd_level_colored.png" class="align-center" src="_images/2nd_level_colored.png" style="width: 200pt;" /></a>
</div>
<div class="section" id="resulting-folder-structure">
<h2>Resulting Folder Structure<a class="headerlink" href="#resulting-folder-structure" title="Permalink to this headline">¶</a></h2>
<p>The resulting folder structure looks as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>output_fMRI_example_2nd
<span class="p">|</span>-- contrasts
    <span class="p">|</span>-- con_0001
    <span class="p">|</span>   <span class="p">|</span>-- con_0001.nii
    <span class="p">|</span>   <span class="p">|</span>-- SPM.mat
    <span class="p">|</span>   <span class="p">|</span>-- spmT_0001.nii
    <span class="p">|</span>-- con_0002
    <span class="p">|</span>-- con_0003
    <span class="p">|</span>-- con_0004
    <span class="p">|</span>-- ess_0005
    <span class="p">|</span>   <span class="p">|</span>-- ess_0005.nii
    <span class="p">|</span>   <span class="p">|</span>-- SPM.mat
    <span class="p">|</span>   <span class="p">|</span>-- spmF_0005.nii
    <span class="p">|</span>-- ess_0006
</pre></div>
</div>
</div>
</div>



          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="help.html" title="Help &amp; Support"
             >next</a></li>
        <li class="right" >
          <a href="normalize.html" title="How To Normalize Your Data"
             >previous</a> |</li>
        <li><a href="index.html">Home</a>|</li>
        <li><a href="http://miykael.github.com/nipype-beginner-s-guide/tableofcontent.html">Table of Contents</a>|</li>
        <li><a href="http://miykael.github.com/nipype-beginner-s-guide/faq.html">FAQ</a>|</li>
        <li><a href="http://miykael.github.com/nipype-beginner-s-guide/glossary.html">Glossary</a>|</li>
        <li><a href="https://github.com/miykael/nipype-beginner-s-guide/">github</a>|</li>
        <li><a href="http://nipy.org/nipype/">Nipype</a>|</li>
        <li><a href="http://miykael.github.io/nipype-beginner-s-guide/help.html">Help</a>|</li> 
      </ul>
    </div>
    <div class="footer">
    <p>
        &copy; Copyright 2016, Michael Notter.
      Last updated on June 10, 2021.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 3.2.1.
    </p>
    <p>
    This page uses <a href="http://analytics.google.com/">Google Analytics</a> to collect statistics. You can disable it by blocking the JavaScript coming from www.google-analytics.com.
    </p>
    </div>
  </body>
</html>